<div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 min-h-[600px]">
  <div class="text-center mb-8">
    <h2 class="text-3xl font-bold text-[#6A5A4F]">AI Plant Analyser</h2>
    <p class="mt-2 text-gray-600 max-w-2xl mx-auto">Use your device's camera or upload an image of a plant leaf, and our AI will diagnose diseases, pests, and nutrient deficiencies.</p>
  </div>

  <!-- Hidden elements for functionality -->
  <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" class="hidden">
  <video #videoElement autoplay playsinline [class]="view() === 'camera' ? 'w-full max-w-md rounded-lg shadow-md mx-auto' : 'hidden'"></video>
  <canvas #canvasElement class="hidden"></canvas>

  @switch (view()) {
    @case ('idle') {
      <div class="flex flex-col items-center justify-center h-full">
        <div class="text-center max-w-lg mx-auto">
          <h3 class="text-xl font-semibold text-[#6A5A4F] mb-6">How would you like to provide an image?</h3>
          <div class="flex flex-col sm:flex-row justify-center gap-4">
            <button (click)="startCamera()" class="flex-1 bg-blue-500 text-white font-bold py-4 px-8 rounded-full shadow-lg hover:bg-blue-600 transition-colors duration-300 flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
              Use Live Camera
            </button>
            <button (click)="triggerFileInput(fileInput)" class="flex-1 bg-green-600 text-white font-bold py-4 px-8 rounded-full shadow-lg hover:bg-green-700 transition-colors duration-300 flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
              Upload from Device
            </button>
          </div>
          @if (cameraError()) {
            <p class="mt-6 text-red-600 bg-red-100 p-3 rounded-md">{{ cameraError() }}</p>
          }
          @if (galleryItems().length > 0) {
            <div class="mt-8">
              <p class="text-gray-500 mb-2">Or, view your past analyses:</p>
              <button (click)="showGallery()" class="bg-gray-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-gray-700 transition-colors duration-300 flex items-center justify-center gap-2 mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 14a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 14a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                View Analysis History
              </button>
            </div>
          }
        </div>
      </div>
    }
    @case('camera') {
      <div class="w-full max-w-md text-center mx-auto">
        <p class="text-gray-500 my-4">Position the plant leaf in the frame and capture a clear photo.</p>
        <div class="flex justify-center gap-4">
          <button (click)="stopCamera()" class="bg-gray-200 text-gray-800 font-bold py-3 px-8 rounded-full shadow-lg hover:bg-gray-300 transition-colors duration-300">
            Cancel
          </button>
          <button (click)="capturePhoto()" class="bg-[#A47E3B] text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-[#8e6b34] transition-colors duration-300 flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            Capture Photo
          </button>
        </div>
      </div>
    }
    @case ('preview') {
      @if (imageBase64()) {
        <div class="w-full max-w-md p-4 border rounded-lg shadow-sm mx-auto">
          <h3 class="font-semibold text-lg text-center mb-4 text-[#6A5A4F]">Image Preview</h3>
          <img [src]="'data:image/jpeg;base64,' + imageBase64()" alt="Plant preview" class="rounded-md max-h-80 mx-auto">
          <div class="flex justify-center gap-4 mt-6">
            <button (click)="reset()" class="bg-gray-200 text-gray-800 font-bold py-3 px-8 rounded-full shadow-lg hover:bg-gray-300 transition-colors duration-300">
              Change Image
            </button>
            <button (click)="analyzeImage()" class="bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-green-700 transition-colors duration-300">
              Analyze Plant Health
            </button>
          </div>
        </div>
      }
    }
    @case ('analyzing') {
      <div class="flex flex-col items-center justify-center text-center h-96">
        <svg class="animate-spin h-12 w-12 text-[#A47E3B]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-lg font-semibold text-[#6A5A4F]">AI is analyzing your plant...</p>
        <p class="text-gray-500">This may take a moment.</p>
      </div>
    }
    @case ('result') {
      @if (analysisResult(); as result) {
        <div class="grid lg:grid-cols-2 gap-8">
          <div class="flex flex-col items-center">
            <img [src]="'data:image/jpeg;base64,' + imageBase64()" alt="Analyzed plant" class="rounded-lg shadow-md max-h-96">
             <button (click)="reset()" class="mt-6 bg-[#A47E3B] text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-[#8e6b34] transition-colors duration-300">
              Start New Analysis
            </button>
          </div>
          <div class="space-y-6">
            <!-- Overall Health -->
            <div>
              <h3 class="text-xl font-bold text-[#6A5A4F] border-b-2 border-[#F1EADF] pb-2 mb-3">Overall Health: <span class="text-[#A47E3B]">{{ result.overallHealth.status }}</span></h3>
              <p class="text-gray-700">{{ result.overallHealth.summary }}</p>
            </div>

            <!-- Detected Issues -->
            @if (result.detectedIssues && result.detectedIssues.length > 0) {
              <div>
                <h3 class="text-xl font-bold text-[#6A5A4F] border-b-2 border-[#F1EADF] pb-2 mb-3">Detected Issues</h3>
                <div class="space-y-4">
                  @for(issue of result.detectedIssues; track issue.name) {
                    <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                      <p class="font-bold text-red-800">{{ issue.name }} ({{ issue.type }})</p>
                      <p class="text-red-700 text-sm">{{ issue.description }}</p>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Nutrient Deficiencies -->
            @if (result.nutrientDeficiencies && result.nutrientDeficiencies.length > 0) {
              <div>
                <h3 class="text-xl font-bold text-[#6A5A4F] border-b-2 border-[#F1EADF] pb-2 mb-3">Nutrient Deficiencies</h3>
                <div class="space-y-4">
                  @for(def of result.nutrientDeficiencies; track def.nutrient) {
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                      <p class="font-bold text-yellow-800">{{ def.nutrient }}</p>
                      <p class="text-yellow-700 text-sm">{{ def.symptoms }}</p>
                    </div>
                  }
                </div>
                @if(hasNpkDeficiency()) {
                  <button (click)="onGenerateFertilizer()" class="mt-4 w-full bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-green-700 transition-colors duration-300 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M11 17a1 1 0 001.447.894l4-2A1 1 0 0017 15V5.236a1 1 0 00-1.447-.894l-4 2a1 1 0 00-.553.894V17zM15 7l-2 1v8l2-1V7z" /><path d="M4 5a2 2 0 100 4h5.586l-1.293 1.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L9.586 5H4z" /></svg>
                    Generate Fertilizer Recipe
                  </button>
                }
              </div>
            }

            <!-- Treatment Recommendations -->
            @if (result.treatmentRecommendations && result.treatmentRecommendations.length > 0) {
              <div>
                <h3 class="text-xl font-bold text-[#6A5A4F] border-b-2 border-[#F1EADF] pb-2 mb-3">Treatment & Action Plan</h3>
                <div class="space-y-4">
                  @for(rec of result.treatmentRecommendations; track rec.title) {
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                      <p class="font-bold text-blue-800 flex items-center">
                        <span class="text-xs mr-2 px-2 py-0.5 rounded-full" [class]="rec.type === 'Organic' ? 'bg-green-200 text-green-800' : (rec.type === 'Chemical' ? 'bg-orange-200 text-orange-800' : 'bg-gray-200 text-gray-800')">{{rec.type}}</span>
                        {{ rec.title }}
                      </p>
                      <ul class="list-disc list-inside text-blue-700 text-sm mt-2 space-y-1">
                        @for(step of rec.steps; track step) {
                          <li>{{step}}</li>
                        }
                      </ul>
                    </div>
                  }
                </div>
              </div>
            }
            
            <!-- Preventive Measures -->
            @if (result.preventiveMeasures && result.preventiveMeasures.length > 0) {
              <div>
                <h3 class="text-xl font-bold text-[#6A5A4F] border-b-2 border-[#F1EADF] pb-2 mb-3">Preventive Measures</h3>
                <ul class="list-disc list-inside text-gray-700 text-sm space-y-1">
                  @for(measure of result.preventiveMeasures; track measure) {
                    <li>{{measure}}</li>
                  }
                </ul>
              </div>
            }

          </div>
        </div>
      }
    }
    @case ('error') {
      <div class="flex flex-col items-center justify-center text-center h-96">
        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert">
          <p class="font-bold">Analysis Failed</p>
          <p>{{ errorMessage() }}</p>
        </div>
        <button (click)="reset()" class="mt-6 bg-[#A47E3B] text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-[#8e6b34] transition-colors duration-300">
          Try Again
        </button>
      </div>
    }
    @case('gallery') {
       <app-image-gallery
        [items]="galleryItems()"
        (view)="handleViewFromGallery($event)"
        (reanalyze)="handleReanalyzeFromGallery($event)"
        (delete)="handleDeleteFromGallery($event)"
        (back)="reset()">
      </app-image-gallery>
    }
  }
</div>
